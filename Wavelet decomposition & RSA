%% Adding path
addpath('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Soroush/matlab_tools');
ini_ext_tools( 'hp2');
ini_ext_tools( 'fieldtriplite');
subject_names = ["Sub_005","Sub_006", "Sub_007", "Sub_008", "Sub_009", "Sub_010", "Sub_011", "Sub_012", "Sub_013", "Sub_014", "Sub_015", "Sub_017", "Sub_019", "Sub_020", "Sub_022", "Sub_023", "Sub_025", "Sub_027", "Sub_028", "Sub_029", "Sub_030", "Sub_031", "Sub_032", "Sub_033","Sub_034", "Sub_035","Sub_037", "Sub_039", "Sub_040", "Sub_041", "Sub_042", "Sub_043", "Sub_044","Sub_045","Sub_046","Sub_048","Sub_049","Sub_050","Sub_052","Sub_053","Sub_054","Sub_055","Sub_201","Sub_202", "Sub_203", "Sub_204", "Sub_205", "Sub_207", "Sub_208","Sub_209", "Sub_210", "Sub_212", "Sub_213", "Sub_214","Sub_215", "Sub_216","Sub_217", "Sub_219","Sub_223","Sub_225", "Sub_226","Sub_227","Sub_228","Sub_229","Sub_230","Sub_231","Sub_232","Sub_233","Sub_234", "Sub_235", "Sub_236","Sub_237","Sub_238","Sub_239", "Sub_240","Sub_241","Sub_242","Sub_243","Sub_244","Sub_245","Sub_246"];
%subject_names = ["Sub_005", "Sub_007", "Sub_008", "Sub_009", "Sub_010", "Sub_011", "Sub_012", "Sub_013", "Sub_014", "Sub_015", "Sub_017", "Sub_019", "Sub_020", "Sub_022", "Sub_023", "Sub_025", "Sub_027", "Sub_028", "Sub_029", "Sub_030", "Sub_031", "Sub_032", "Sub_033", "Sub_035", "Sub_202", "Sub_203", "Sub_204", "Sub_205", "Sub_207", "Sub_208", "Sub_210", "Sub_212", "Sub_213", "Sub_214","Sub_215", "Sub_217", "Sub_219","Sub_225", "Sub_226","Sub_227","Sub_228","Sub_229","Sub_231","Sub_232", "Sub_234", "Sub_235", "Sub_236"];

proc_load_behav = 0;
proc_convert_eeglab2fdtp = 1;
proc_load_hp = 0;
proc_run_wavelet = 1;
proc_run_create_sub_avg_conditions = 1;
proc_rm_vars = 0;
%% wavelet decomposition Encoding



encPath='/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Encoding/EncodingMerge';
matFilesEnc = dir(fullfile(encPath, '*.mat'));
% subject_names = ["Sub_001", "Sub_002", "Sub_003", "Sub_004", "Sub_005", "Sub_006", "Sub_007", "Sub_008", "Sub_009", "Sub_010", "Sub_011", "Sub_013", "Sub_014", "Sub_015", "Sub_016", "Sub_017", "Sub_018", "Sub_019", "Sub_020", "Sub_022", "Sub_023", "Sub_024", "Sub_025", "Sub_026", "Sub_027", "Sub_029", "Sub_030", "Sub_031", "Sub_032", "Sub_033", "Sub_034", "Sub_035", "Sub_036", "Sub_037", "Sub_038", "Sub_039", "Sub_040", "Sub_041", "Sub_043", "Sub_044", "Sub_045", "Sub_046", "Sub_047"];
% behavioral_ret12 = ["Sub_001_3d_mem_ret12_Recognition_demo_pics_2022-10-20_13h32.01.442.csv", "Sub_002_3d_mem_ret12_Recognition_demo_pics_2022-10-21_16h04.16.749.csv", "Sub_003_3d_mem_ret12_Recognition_demo_pics_2022-10-26_17h06.54.888.csv", "Sub_004_3d_mem_ret12_Recognition_demo_pics_2022-10-27_13h41.30.885.csv", "Sub_005_3d_mem_ret12_Recognition_demo_pics_2022-10-28_16h20.01.501.csv", "Sub_006_3d_mem_ret12_Recognition_demo_pics_2022-10-31_14h00.54.112.csv", "Sub_007_3d_mem_ret12_Recognition_demo_pics_2022-11-02_16h59.41.111.csv", "Sub_008_3d_mem_ret12_Recognition_demo_pics_2022-11-03_16h42.51.273.csv", "Sub_009_3d_mem_ret12_Recognition_demo_pics_2022-11-07_16h57.26.512.csv", "Sub_010_3d_mem_ret12_Recognition_demo_pics_2022-11-09_15h14.27.636.csv", "Sub_011_3d_mem_ret12_Recognition_demo_pics_2022-11-10_14h17.40.803.csv", "Sub_013_3d_mem_ret12_Recognition_demo_pics_2022-11-14_16h13.13.275.csv", "Sub_014_3d_mem_ret12_Recognition_demo_pics_2022-11-16_17h06.21.335.csv", "Sub_015_3d_mem_ret12_Recognition_demo_pics_2022-11-17_16h06.34.768.csv", "Sub_016_3d_mem_ret12_Recognition_demo_pics_2022-11-18_16h10.27.993.csv", "Sub_017_3d_mem_ret12_Recognition_demo_pics_2022-11-28_16h23.50.272.csv", "Sub_018_3d_mem_ret12_Recognition_demo_pics_2022-11-29_16h45.55.021.csv", "Sub_019_3d_mem_ret12_Recognition_demo_pics_2022-11-30_15h29.46.190.csv", "Sub_20_3d_mem_ret12_Recognition_demo_pics_2022-12-01_15h18.54.798.csv", "Sub_022_3d_mem_ret12_Recognition_demo_pics_2022-12-05_15h32.47.788.csv", "Sub_23_3d_mem_ret12_Recognition_demo_pics_2022-12-06_16h03.32.409.csv", "Sub_024_3d_mem_ret12_Recognition_demo_pics_2022-12-07_14h24.10.816.csv", "Sub_025_3d_mem_ret12_Recognition_demo_pics_2022-12-08_14h19.43.220.csv", "Sub_026_3d_mem_ret12_Recognition_demo_pics_2022-12-09_15h48.11.636.csv", "Sub_027_3d_mem_ret12_Recognition_demo_pics_2022-12-12_12h00.59.916.csv", "Sub_029_3d_mem_ret12_Recognition_demo_pics_2022-12-15_14h07.42.426.csv", "Sub_030_3d_mem_ret12_Recognition_demo_pics_2022-12-16_16h09.54.703.csv", "Sub_031_3d_mem_ret12_Recognition_demo_pics_2023-01-09_13h45.48.480.csv", "Sub_032_3d_mem_ret12_Recognition_demo_pics_2023-01-11_17h49.36.386.csv", "Sub_033_3d_mem_ret12_Recognition_demo_pics_2023-01-13_12h18.24.222.csv", "Sub_034_3d_mem_ret12_Recognition_demo_pics_2023-01-16_12h26.41.871.csv", "Sub_035_3d_mem_ret12_Recognition_demo_pics_2023-01-16_16h12.51.994.csv", "Sub_036_3d_mem_ret12_Recognition_demo_pics_2023-01-18_11h24.44.657.csv", "Sub_037_3d_mem_ret12_Recognition_demo_pics_2023-01-18_17h30.31.448.csv", "Sub_038_3d_mem_ret12_Recognition_demo_pics_2023-01-20_15h22.21.540.csv", "Sub_039_3d_mem_ret12_Recognition_demo_pics_2023-01-23_15h23.35.637.csv", "Sub_040_3d_mem_ret12_Recognition_demo_pics_2023-01-25_11h56.03.350.csv", "Sub_041_3d_mem_ret12_Recognition_demo_pics_2023-01-25_15h47.32.809.csv", "Sub_043_3d_mem_ret12_Recognition_demo_pics_2023-01-30_17h09.59.133.csv", "Sub_044_3d_mem_ret12_Recognition_demo_pics_2023-02-01_17h10.04.233.csv", "Sub_045_3d_mem_ret12_Recognition_demo_pics_2023-02-06_14h55.37.357.csv", "Sub_046_3d_mem_ret12_Recognition_demo_pics_2023-02-08_12h49.15.748.csv", "Sub_047_3d_mem_ret12_Recognition_demo_pics_2023-02-13_17h30.52.893.csv"];
% behavioral_ret34 = ["Sub_001_3d_mem_ret34_Recognition_demo_pics_2022-10-20_13h54.07.518.csv", "Sub_002_3d_mem_ret34_Recognition_demo_pics_2022-10-21_16h25.49.990.csv", "Sub_003_3d_mem_ret34_Recognition_demo_pics_2022-10-26_17h31.48.207.csv", "Sub_004_3d_mem_ret34_Recognition_demo_pics_2022-10-27_14h06.44.370.csv", "Sub_005_3d_mem_ret34_Recognition_demo_pics_2022-10-28_16h41.22.632.csv", "Sub_006_3d_mem_ret34_Recognition_demo_pics_2022-10-31_14h22.19.922.csv", "Sub_007_3d_mem_ret34_Recognition_demo_pics_2022-11-02_17h21.29.478.csv", "Sub_008_3d_mem_ret34_Recognition_demo_pics_2022-11-03_17h03.26.999.csv", "Sub_009_3d_mem_ret34_Recognition_demo_pics_2022-11-07_17h17.50.601.csv", "Sub_010_3d_mem_ret34_Recognition_demo_pics_2022-11-09_15h37.25.448.csv", "Sub_011_3d_mem_ret34_Recognition_demo_pics_2022-11-10_14h39.19.614.csv", "Sub_013_3d_mem_ret34_Recognition_demo_pics_2022-11-14_16h34.46.396.csv", "Sub_014_3d_mem_ret34_Recognition_demo_pics_2022-11-16_17h26.05.921.csv", "Sub_015_3d_mem_ret34_Recognition_demo_pics_2022-11-17_16h28.17.896.csv", "Sub_016_3d_mem_ret34_Recognition_demo_pics_2022-11-18_16h36.17.946.csv", "Sub_017_3d_mem_ret34_Recognition_demo_pics_2022-11-28_16h45.33.632.csv", "Sub_018_3d_mem_ret34_Recognition_demo_pics_2022-11-29_17h11.10.094.csv", "Sub_019_3d_mem_ret34_Recognition_demo_pics_2022-11-30_15h52.58.951.csv", "Sub_20_3d_mem_ret34_Recognition_demo_pics_2022-12-01_15h38.01.904.csv", "Sub_022_3d_mem_ret34_Recognition_demo_pics_2022-12-05_15h57.16.859.csv", "Sub_23_3d_mem_ret34_Recognition_demo_pics_2022-12-06_16h30.24.599.csv", "Sub_024_3d_mem_ret34_Recognition_demo_pics_2022-12-07_14h50.27.513.csv", "Sub_025_3d_mem_ret34_Recognition_demo_pics_2022-12-08_14h44.20.147.csv", "Sub_026_3d_mem_ret34_Recognition_demo_pics_2022-12-09_16h14.51.621.csv", "Sub_027_3d_mem_ret34_Recognition_demo_pics_2022-12-12_12h31.32.804.csv", "Sub_029_3d_mem_ret34_Recognition_demo_pics_2022-12-15_14h35.11.276.csv", "Sub_030_3d_mem_ret34_Recognition_demo_pics_2022-12-16_16h57.46.970.csv", "Sub_031_3d_mem_ret34_Recognition_demo_pics_2023-01-09_14h10.57.281.csv", "Sub_032_3d_mem_ret34_Recognition_demo_pics_2023-01-11_18h12.15.888.csv", "Sub_033_3d_mem_ret34_Recognition_demo_pics_2023-01-13_12h44.23.041.csv", "Sub_034_3d_mem_ret34_Recognition_demo_pics_2023-01-16_12h56.17.899.csv", "Sub_035_3d_mem_ret34_Recognition_demo_pics_2023-01-16_16h42.48.776.csv", "Sub_036_3d_mem_ret34_Recognition_demo_pics_2023-01-18_11h50.12.662.csv", "Sub_037_3d_mem_ret34_Recognition_demo_pics_2023-01-18_17h57.31.610.csv","Sub_038_3d_mem_ret34_Recognition_demo_pics_2023-01-20_15h52.29.135.csv", "Sub_039_3d_mem_ret34_Recognition_demo_pics_2023-01-23_15h49.42.815.csv", "Sub_040_3d_mem_ret34_Recognition_demo_pics_2023-01-25_12h23.36.677.csv", "Sub_041_3d_mem_ret34_Recognition_demo_pics_2023-01-25_16h14.40.438.csv", "Sub_043_3d_mem_ret34_Recognition_demo_pics_2023-01-30_17h36.28.974.csv", "Sub_044_3d_mem_ret34_Recognition_demo_pics_2023-02-01_17h38.45.540.csv", "Sub_045_3d_mem_ret34_Recognition_demo_pics_2023-02-06_15h26.37.465.csv", "Sub_046_3d_mem_ret34_Recognition_demo_pics_2023-02-08_13h19.14.073.csv", "Sub_047_3d_mem_ret34_Recognition_demo_pics_2023-02-13_18h01.38.423.csv"];
% 
% counter_balance = ["a", "b", "c", "d", "e", "f", "a", "b", "c", "d", "e", "a", "b", "c", "d", "e", "f", "a", "b", "d", "e", "f", "a", "b", "c", "e", "f", "a", "b", "c", "d", "e", "f", "a", "b", "c", "d", "e", "a", "b", "c", "d", "e"];

% project_path_ret ="/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated/" + matFilesRet(1).name + "/";
% project_path_enc ="/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Encoding/EncodingMerge/" + matFilesEnc(1).name + "/";
% EEG_file = load(project_path_ret);
    


% proc_load_behav = 0;
% proc_convert_eeglab2fdtp = 1;
% proc_load_hp = 0;
% proc_run_wavelet = 1;
% proc_run_create_sub_avg_conditions = 1;
% proc_rm_vars = 0;

for n = 81:82%1:length(matFilesEnc)
 

    project_path_enc ="/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Encoding/EncodingMerge/" + matFilesEnc(n).name + "/";


    if proc_convert_eeglab2fdtp == 1
    
        %EEG = fn_eeglab_quick_load( folder_input_path, file_input );
        
        EEG_file = load(project_path_enc);
        EEG = EEG_file.EEG;
        
        [fdtp_eeg, fdtp_sub_enc ] = fdtp_convert_eeg2fieldtrip_2( EEG );
        [fdtp_eeg]   = ft_checkdata(fdtp_eeg);
    
        %tt.subVal    = subject_names(n) + "_enc12";
        % tt.subVal    = subject_names(n);
        % fdtp_sub.setname = [tt.subVal];
        % fdtp_eeg.etc.setname = [tt.subVal];
    
    end
    
    % Run wavelet analysis
    cfg = [];
    cfg.channel    = 'EEG';
    cfg.timeOfInt   = [-1 3]; % This is similar to how my data are epoched, from -1 to 3.5
    
    cfg.numCycles   = 5;
    cfg.freqOfInt   = 3:1:40;
    
    cfg.outputType  = 'pow';
    cfg.method = 'wavelet';
    [ fdtp_pow_enc,outD_enc ] = fdtp_run_wavelet( cfg, fdtp_eeg );
    %A=ft_freqanalysis(cfg, fdtp_eeg);
    fdtp_sub_enc.proc.wavelet = outD_enc;
    fdtp_pow_enc.etc = fdtp_sub_enc;
    fdtp_sub_enc.filename = subject_names(n) + "enc_pow";
    %fdtp_sub.filepath  = folder_output_path;
    fdtp_sub_enc.filepath  = encPath +"/ENC_power";
     saveData  = fullfile(fdtp_sub_enc.filepath,fdtp_sub_enc.filename);
     disp(['HP: Saving: ',saveData]);
     fdtp_pow_enc.behave=EEG_file.EEG.etc.behavioral_data;
% imagesc(squeeze(log(fdtp_pow_ret2.powspctrm(10,10,:,:))))
% imagesc(squeeze(log(fdtp_pow_enc.powspctrm(1,1,:,:))))
        save(saveData,'fdtp_pow_enc','fdtp_sub_enc');
        clear fdtp_pow_enc
        clear fdtp_sub_enc
        clear EEG

end



%% wavelet decomposition Retreival
retPath = "/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/"; %+ matFiles(n).name + "/";  % Specify the folder path where the .csv files are located
matFilesRet = dir(fullfile(retPath, '*.mat'));
for n = 80:81%38:length(matFilesRet)


    project_path_ret ="/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/" + matFilesRet(n).name + "/";
    if proc_convert_eeglab2fdtp == 1

        %EEG = fn_eeglab_quick_load( folder_input_path, file_input );

        EEG_file = load(project_path_ret);
        EEG = EEG_file.EEG;

        [fdtp_eeg, fdtp_sub_ret2 ] = fdtp_convert_eeg2fieldtrip_2( EEG );
        [fdtp_eeg]   = ft_checkdata(fdtp_eeg);

        %tt.subVal    = subject_names(n) + "_enc12";
        % tt.subVal    = subject_names(n);
        % fdtp_sub.setname = [tt.subVal];
        % fdtp_eeg.etc.setname = [tt.subVal];

    end

    % Run wavelet analysis
    cfg = [];
    cfg.channel    = 'EEG';
    cfg.timeOfInt   = [-1 3]; % This is similar to how my data are epoched, from -1 to 3.5

    cfg.numCycles   = 5;
    cfg.freqOfInt   = 3:1:40;

    cfg.outputType  = 'pow';
    cfg.method = 'wavelet';
    [ fdtp_pow_ret2,outD_ret2 ] = fdtp_run_wavelet( cfg, fdtp_eeg );
    fdtp_sub_ret2.proc.wavelet = outD_ret2;
    fdtp_pow_ret2.etc = fdtp_sub_ret2;
    fdtp_sub_ret2.filename = subject_names(n) + "ret2_pow";
    %fdtp_sub.filepath  = folder_output_path;
    fdtp_sub_ret2.filepath  = retPath +"/Ret2_power";
    saveData  = fullfile(fdtp_sub_ret2.filepath,fdtp_sub_ret2.filename);
    disp(['HP: Saving: ',saveData]);
    % trial kind
    filePattern = fullfile(retPath, '*.mat');  % Specify the file pattern to match .csv files
    retFiles = dir(filePattern);  % Get information about .csv files in the folder

    % Loop through each .csv file and display its full path
    % cd '/Users/ms87986/Downloads/Behavioral Data/s_003/retrieval day1/Part1'
    % tableRet=
    EEG_file = load(project_path_ret);
    tableRet= EEG_file.EEG.etc.behavioral_data;
    t=1;
    index=0;
    for j=1:height(tableRet)
        R=strcmp(tableRet.key_resp_keys(j),'');

        if R==1
            index(:,t)=j;
            t=t+1;


        end

    end
    if index ~= 0
        tableRet(index, : ) = [];
    end



    for i=1:height(tableRet)

        U=contains(tableRet.Type(i),'U');
        C=contains(tableRet.Type(i),'C');
        N=contains(tableRet.Type(i),'N');
        NONE=contains(tableRet.key_resp_keys(i),'None');
        Num1=contains(tableRet.key_resp_keys(i),'num_1');
        Num2=contains(tableRet.key_resp_keys(i),'num_2');
        Num3=contains(tableRet.key_resp_keys(i),'num_3');
        BadR=contains(tableRet.key_resp_keys(i),',');
        if U==1
            if NONE==1
                trialKind{i,:}='NoResponse';
            end
            if BadR==1
                trialKind{i,:}='badResponse';
            end
            if Num1==1
                trialKind{i,:}='Hit';
            end

            if Num2==1
                trialKind{i,:}='Miss';
            end
            if Num3==1
                trialKind{i,:}='itemMiss';
            end
        end

        if C==1
            if NONE==1
                trialKind{i,:}='NoResponse';
            end

            if BadR==1
                trialKind{i,:}='badResponse';
            end

            if Num1==1
                trialKind{i,:}='falseAlarm';
            end

            if Num2==1
                trialKind{i,:}='correctRejection';
            end
            if Num3==1
                trialKind{i,:}='itemMiss';
            end

        end
        if N==1
            if NONE==1
                trialKind{i,:}='NoResponse';
            end
            if BadR==1
                trialKind{i,:}='badResponse';
            end
            if Num1==1
                trialKind{i,:}='itemFA';
            end

            if Num2==1
                trialKind{i,:}='itemFA';
            end
            if Num3==1
                trialKind{i,:}='itemCR';
            end

        end
    end


    TF = contains(trialKind, 'Hit');
    NumberOfHit=length(trialKind(TF))

    TF = contains(trialKind, 'Miss');
    TN = contains(trialKind, 'itemMiss');
    NumberOfMiss=length(trialKind(TF))-length(trialKind(TN))
    TF = contains(trialKind, 'correctRejection');
    NumberOf_correctRejection=length(trialKind(TF))
    TF = contains(trialKind, 'falseAlarm');
    NumberOf_falseAlarm=length(trialKind(TF))

    % TF = contains(trialKind, 'itemCR');
    % NumberOf_itemCR=length(trialKind(TF))
    fdtp_pow_ret2.trialkind=trialKind;
    fdtp_pow_ret2.behave=EEG_file.EEG.etc.behavioral_data;


    save(saveData,'fdtp_pow_ret2','fdtp_sub_ret2');
    clear fdtp_pow_ret2
    clear fdtp_sub_ret2
    clear trialKind
    clear EEG
end

%% Preallocate
channels = zeros(6,4);
channels(:,1) = [1,3,4,5,6,7]; % left frontal=(Fp1, F3, F7, FT9, FC5, FC1)
channels(:,2) = [26,27,28,29,30,31]; % right frontal=(FT10, FC6, FC2, F4, F8, Fp2)
channels(:,3) = [10,11,12,14,15,16]; % left centroposterior= (TP9, CP5, CP1, P3, P7, O1)
channels(:,4) = [18,19,20,21,22,23]; % right centroposterior= (O2, P4, P8,TP10, CP6, CP2)
ch_lable={'left frontal','right frontal','left centroposterior','right centroposterior'};

%subject_names = ["Sub_005", "Sub_007", "Sub_008", "Sub_009", "Sub_010", "Sub_011", "Sub_012", "Sub_013", "Sub_014", "Sub_015", "Sub_017", "Sub_019", "Sub_020", "Sub_022", "Sub_023", "Sub_025", "Sub_027", "Sub_028", "Sub_029", "Sub_030", "Sub_031", "Sub_032", "Sub_033", "Sub_035", "Sub_202", "Sub_203", "Sub_204", "Sub_205", "Sub_207", "Sub_208", "Sub_210", "Sub_212", "Sub_213", "Sub_214", "Sub_217", "Sub_219"];

%subject_names = [  "Sub_215", "Sub_225", "Sub_226","Sub_227","Sub_228", "Sub_229","Sub_231", "Sub_232","Sub_235","Sub_236"];


%subject_names =["Sub_050","Sub_052","Sub_053","Sub_054","Sub_055","Sub_243","Sub_245","Sub_246"];
subject_names = ["Sub_005","Sub_006", "Sub_007","Sub_009","Sub_010", ...
                 "Sub_011","Sub_012", "Sub_013", "Sub_015", ...
                 "Sub_017", "Sub_019", "Sub_020", "Sub_022", "Sub_023", ...
                 "Sub_027", "Sub_028", ...
                 "Sub_032", "Sub_033","Sub_034", "Sub_035","Sub_037","Sub_039",...
                 "Sub_040","Sub_041","Sub_042","Sub_043","Sub_044","Sub_045","Sub_046","Sub_048", ...
                 "Sub_050","Sub_052","Sub_053","Sub_054","Sub_055",...
                 "Sub_201","Sub_202", ...
                 "Sub_203", "Sub_204", "Sub_205", "Sub_207","Sub_209",...
                 "Sub_210", "Sub_212", "Sub_213", "Sub_214","Sub_215","Sub_216", "Sub_217", "Sub_219", ...
                 "Sub_223","Sub_225","Sub_226","Sub_227","Sub_228","Sub_229","Sub_230","Sub_231","Sub_232","Sub_233",...
                 "Sub_234","Sub_235","Sub_237","Sub_238","Sub_239","Sub_240",...
                 "Sub_242","Sub_243","Sub_245","Sub_246"];


%% Calculating RSA for hit trials
for S=1:length(subject_names)
    % retPath = "/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated"; %+ matFiles(n).name + "/";  % Specify the folder path where the .csv files are located
    % encPath='/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Encoding/EncodingMerge';

load(subject_names(S)+'enc_pow.mat')
load(subject_names(S)+'ret2_pow.mat')
temp_within_similarity_hit  = [];
temp_between_similarity_hit = [];


trialHit=1;
HitIndex = find(strcmp(fdtp_pow_ret2.trialkind, 'Hit'));

for i=HitIndex'
   clear temp_temp_between_similarity_hit
   EncHitindex = [];

   
        trig=fdtp_pow_ret2.behave.TriggerFinal(i);
        index = find(fdtp_pow_enc.behave.TriggerFinal == trig);
       
        % Remove the specific numbers
       HitIndexRemoved = setdiff(HitIndex, i);

        
        vv=1;
        for ret=HitIndexRemoved'
            trigOther=fdtp_pow_ret2.behave.TriggerFinal(ret);
            indices = find(fdtp_pow_enc.behave.TriggerFinal == trigOther);
            if isempty(indices)
            vv=vv;
            else
            % Assign the found indices
            EncHitindex(vv, :) = indices;
            vv=vv+1;
            end
            
        end

        % Display the updated HitIndex
  
        if ~isempty(index)
            fprintf('Number %d found at row index %d\n', trig, index);
        
            for chGroup=1:4
                for EE=7:32
                    for RR=7:32

                        EncodingTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(index,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_within_similarity_hit(trialHit,chGroup,EE-6,RR-6)=corr(EncodingTrialWithin(:), RetrivalTrialWithin(:), 'Rows','complete');
                        tt=1;
                        for ind=EncHitindex'
                        EncodingTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(ind,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_temp_between_similarity_hit(tt,chGroup,EE-6,RR-6)=corr(EncodingTrialBetween,RetrivalTrialBetween);
                        tt=tt+1;
                        end
                        temp_between_similarity_hit(trialHit,chGroup,EE-6,RR-6)=squeeze(nanmean(temp_temp_between_similarity_hit(:,chGroup,EE-6,RR-6),1));
                    end
                end
            end
          trialHit=trialHit+1;
         else
           fprintf('Number %d not found in the column\n', trig);

        end

   
  
end
% Average over all hits
within_similarity_hit=squeeze(mean(temp_within_similarity_hit));
between_similarity_hit=squeeze(mean(temp_between_similarity_hit));
With_Bet=within_similarity_hit-between_similarity_hit;
    filename = subject_names(S) + "RSA_Hit";
    
    filepath  = "/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/RSA_FA_with_bit_2";
    saveData  = fullfile(filepath,filename);
    disp(['HP: Saving: ',saveData]);
 save(saveData,'With_Bet');
 clearvars -except channels subject_names

end
% between_similarity_hit_all_Subjects(S,:,:,:)=between_similarity_hit_S;
%end
%%
% Assume A is your 4x26x26 matrix
A = With_Bet; % Example matrix with random values

% Create a figure for the subplots
figure;

% Loop through each 26x26 matrix
for i = 1:4
    % Extract the i-th 26x26 matrix
    M = squeeze(A(i, :, :));
    
    % Replace values as specified
    M(M >= 0) = 1;
    M(M < 0) = 0;
    
    % Create subplot and plot the matrix
    subplot(2, 2, i);
    imagesc(M);
    colorbar;
    title(ch_lable{i});
end


%% Calculating RSA for miss trials
for S=1:length(subject_names)
    % retPath = "/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated"; %+ matFiles(n).name + "/";  % Specify the folder path where the .csv files are located
    % encPath='/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Encoding/EncodingMerge';

load('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Encoding/EncodingMerge/ENC_power/' + subject_names(S)+'enc_pow.mat')
load('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/' + subject_names(S) + 'ret2_pow.mat')
temp_within_similarity_hit  = [];
temp_between_similarity_hit = [];


trialHit=1;
HitIndex = find(strcmp(fdtp_pow_ret2.trialkind, 'Miss'));

for i=HitIndex'
   clear temp_temp_between_similarity_hit
   EncHitindex = [];

   
        trig=fdtp_pow_ret2.behave.TriggerFinal(i);
        index = find(fdtp_pow_enc.behave.TriggerFinal == trig);
       
        % Remove the specific numbers
         HitIndexRemoved = setdiff(HitIndex, i);
        
        vv=1;
        for ret=HitIndexRemoved'
            trigOther=fdtp_pow_ret2.behave.TriggerFinal(ret);
            indices = find(fdtp_pow_enc.behave.TriggerFinal == trigOther);
            if isempty(indices)
            vv=vv;
            else
            % Assign the found indices
            EncHitindex(vv, :) = indices;
            vv=vv+1;
            end
            
        end

        % Display the updated HitIndex
  
        if ~isempty(index)
            fprintf('Number %d found at row index %d\n', trig, index);
        
            for chGroup=1:4
                for EE=7:32
                    for RR=7:32

                        EncodingTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(index,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_within_similarity_hit(trialHit,chGroup,EE-6,RR-6)=corr(EncodingTrialWithin(:), RetrivalTrialWithin(:), 'Rows','complete');
                        tt=1;
                        for ind=EncHitindex'
                        EncodingTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(ind,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_temp_between_similarity_hit(tt,chGroup,EE-6,RR-6)=corr(EncodingTrialBetween,RetrivalTrialBetween);
                        tt=tt+1;
                        end
                        temp_between_similarity_hit(trialHit,chGroup,EE-6,RR-6)=squeeze(nanmean(temp_temp_between_similarity_hit(:,chGroup,EE-6,RR-6),1));
                    end
                end
            end
          trialHit=trialHit+1;
         else
           fprintf('Number %d not found in the column\n', trig);

        end

   
  
end
% Average over all hits
within_similarity_hit=squeeze(mean(temp_within_similarity_hit));
between_similarity_hit=squeeze(mean(temp_between_similarity_hit));
With_Bet=within_similarity_hit-between_similarity_hit;
    filename = subject_names(S) + "RSA_Miss";
    
    filepath  = "/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/RSA_Miss_with_bit_2";
    saveData  = fullfile(filepath,filename);
    disp(['HP: Saving: ',saveData]);
 save(saveData,'With_Bet');
 clearvars -except channels subject_names

end
 %% Calculating RSA for correct rejection trials
for S=1:length(subject_names)
    % retPath = "/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated"; %+ matFiles(n).name + "/";  % Specify the folder path where the .csv files are located
    % encPath='/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Encoding/EncodingMerge';

load('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Encoding/EncodingMerge/ENC_power/' + subject_names(S)+'enc_pow.mat')
load('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/' + subject_names(S) + 'ret2_pow.mat')
temp_within_similarity_hit  = [];
temp_between_similarity_hit = [];


trialHit=1;
HitIndex = find(strcmp(fdtp_pow_ret2.trialkind, 'correctRejection'));

for i=HitIndex'
   clear temp_temp_between_similarity_hit
   EncHitindex = [];

   
        trig=fdtp_pow_ret2.behave.TriggerFinal(i);
        index = find(fdtp_pow_enc.behave.TriggerFinal == trig);
       
        % Remove the specific numbers
       HitIndexRemoved = setdiff(HitIndex, i);
        
        vv=1;
        for ret=HitIndexRemoved'
            trigOther=fdtp_pow_ret2.behave.TriggerFinal(ret);
            indices = find(fdtp_pow_enc.behave.TriggerFinal == trigOther);
            if isempty(indices)
            vv=vv;
            else
            % Assign the found indices
            EncHitindex(vv, :) = indices;
            vv=vv+1;
            end
            
        end

        % Display the updated HitIndex
  
        if ~isempty(index)
            fprintf('Number %d found at row index %d\n', trig, index);
        
            for chGroup=1:4
                for EE=7:32
                    for RR=7:32

                        EncodingTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(index,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_within_similarity_hit(trialHit,chGroup,EE-6,RR-6)=corr(EncodingTrialWithin(:), RetrivalTrialWithin(:), 'Rows','complete');
                        tt=1;
                        for ind=EncHitindex'
                        EncodingTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(ind,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_temp_between_similarity_hit(tt,chGroup,EE-6,RR-6)=corr(EncodingTrialBetween,RetrivalTrialBetween);
                        tt=tt+1;
                        end
                        temp_between_similarity_hit(trialHit,chGroup,EE-6,RR-6)=squeeze(nanmean(temp_temp_between_similarity_hit(:,chGroup,EE-6,RR-6),1));
                    end
                end
            end
          trialHit=trialHit+1;
         else
           fprintf('Number %d not found in the column\n', trig);

        end

   
  
end
% Average over all hits
within_similarity_hit=squeeze(mean(temp_within_similarity_hit));
between_similarity_hit=squeeze(mean(temp_between_similarity_hit));
With_Bet=within_similarity_hit-between_similarity_hit;
    filename = subject_names(S) + "RSA_CR";
    
    filepath  = "/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/RSA_CR_with_bit_2";
    saveData  = fullfile(filepath,filename);
    disp(['HP: Saving: ',saveData]);
 save(saveData,'With_Bet');
 clearvars -except channels subject_names

end
%% Calculating RSA for false alarm trials
for S=1:length(subject_names)
    % retPath = "/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated"; %+ matFiles(n).name + "/";  % Specify the folder path where the .csv files are located
    % encPath='/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Encoding/EncodingMerge';

load('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Encoding/EncodingMerge/ENC_power/' + subject_names(S)+'enc_pow.mat')
load('/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/' + subject_names(S) + 'ret2_pow.mat')
temp_within_similarity_hit  = [];
temp_between_similarity_hit = [];


trialHit=1;
HitIndex = find(strcmp(fdtp_pow_ret2.trialkind, 'falseAlarm'));

for i=HitIndex'
   clear temp_temp_between_similarity_hit
   EncHitindex = [];



   
        trig=fdtp_pow_ret2.behave.TriggerFinal(i);
        index = find(fdtp_pow_enc.behave.TriggerFinal == trig);
       
        % Remove the specific numbers
       HitIndexRemoved = setdiff(HitIndex, i);
        
        vv=1;
        for ret=HitIndexRemoved'
            trigOther=fdtp_pow_ret2.behave.TriggerFinal(ret);
            indices = find(fdtp_pow_enc.behave.TriggerFinal == trigOther);
            if isempty(indices)
            vv=vv;
            else
            % Assign the found indices
            EncHitindex(vv, :) = indices;
            vv=vv+1;
            end
            
        end

        % Display the updated HitIndex
  
        if ~isempty(index)
            fprintf('Number %d found at row index %d\n', trig, index);
        
            for chGroup=1:4
                for EE=7:32
                    for RR=7:32

                        EncodingTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(index,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialWithin=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_within_similarity_hit(trialHit,chGroup,EE-6,RR-6)=corr(EncodingTrialWithin(:), RetrivalTrialWithin(:), 'Rows','complete');

                        tt=1;
                        for ind=EncHitindex'
                        EncodingTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_enc.powspctrm(ind,channels(:,chGroup),:,(EE*5 - 4):(EE*5 + 10)),4),2)));
                        RetrivalTrialBetween=log10(squeeze(nanmean(nanmean(fdtp_pow_ret2.powspctrm(i,channels(:,chGroup),:,(RR*5 - 4):(RR*5 + 10)),4),2)));
                        temp_temp_between_similarity_hit(tt,chGroup,EE-6,RR-6)=corr(EncodingTrialBetween,RetrivalTrialBetween);
                        tt=tt+1;
                        end
                        temp_between_similarity_hit(trialHit,chGroup,EE-6,RR-6)=squeeze(nanmean(temp_temp_between_similarity_hit(:,chGroup,EE-6,RR-6),1));
                    end
                end
            end
          trialHit=trialHit+1;
         else
           fprintf('Number %d not found in the column\n', trig);

        end

   
  
end
% Average over all hits
within_similarity_hit=squeeze(mean(temp_within_similarity_hit));
between_similarity_hit=squeeze(mean(temp_between_similarity_hit));
With_Bet=within_similarity_hit-between_similarity_hit;
    filename = subject_names(S) + "RSA_FA";
    
    filepath  = '/Users/mseraji1/Library/CloudStorage/OneDrive-TheUniversityofTexasatAustin/Documents - PSYC-Research-Duarte_Lab/Sleep Study/Analysis & Preprocessed Data/Preproccessed EEG (Masoud)/Retrieval Day 2/updated/Ret2_power/RSA_FA_with_bit_2';
    saveData  = fullfile(filepath,filename);
    disp(['HP: Saving: ',saveData]);
 save(saveData,'With_Bet');
 clearvars -except channels subject_names

end

%% Loading data for statistical
subject_names = ["Sub_005", "Sub_007", "Sub_008", "Sub_009", "Sub_010", "Sub_011", "Sub_012", "Sub_013", "Sub_014", "Sub_015", "Sub_017", "Sub_019", "Sub_020", "Sub_022", "Sub_023", "Sub_025", "Sub_027", "Sub_028", "Sub_029", "Sub_030", "Sub_031", "Sub_032", "Sub_033", "Sub_035", "Sub_202", "Sub_203", "Sub_204", "Sub_205", "Sub_207", "Sub_208", "Sub_210", "Sub_212", "Sub_213", "Sub_214", "Sub_217", "Sub_219"];
RSA_Hit=zeros(36,4,26,26);
RSA_Miss=zeros(36,4,26,26);
Hit_Miss=zeros(36,4,26,26);
for S=1:36
RSA_Hit_data=load('/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated/Ret2_power/RSA_Hit_with_bet/' + subject_names(S)+'RSA_Hit.mat');
RSA_Miss_data=load('/Users/mseraji1/Library/CloudStorage/OneDrive-SharedLibraries-TheUniversityofTexasatAustin/PSYC-Research-Duarte_Lab - Documents/Skintronics Study/Analysis/Preproccessed_EEG_Masoud/Retrieval Day 2/updated/Ret2_power/RSA_Miss_with_bet/' + subject_names(S) +'RSA_Miss.mat');
RSA_Hit(S,:,:,:)=double(RSA_Hit_data.With_Bet);
RSA_Miss(S,:,:,:)=double(RSA_Miss_data.With_Bet);
Hit_Miss(S,:,:,:)=RSA_Hit(S,:,:,:)-RSA_Miss(S,:,:,:);
end
p_values = zeros(4, 26, 26);
t_values = zeros(4, 26, 26);
for i = 1:4
    for j = 1:26
        for k = 1:26
            [h, p, ci, stats] = ttest2(RSA_Hit(:,i,j,k), RSA_Miss(:,i,j,k));
            p_values(i, j, k) = p;
            t_values(i, j, k) = stats.tstat;
        end
    end
end
%%
% Load your mask and RSA data
mask = squeeze(region_mask(4,:,:)); % Example mask
num_subjects = 36; % Example number of subjects
RSA_HIT = squeeze(RSA_Hit(:,4,:,:)); % Example RSA HIT data
RSA_MISS = squeeze(RSA_Miss(:,4,:,:));; % Example RSA MISS data
RSA_HIT_Miss=RSA_HIT-RSA_MISS;
% Identify clusters in the mask
[L, num_clusters] = bwlabel(mask);

% Initialize arrays to hold average values
avg_HIT = zeros(num_subjects, num_clusters);
avg_MISS = zeros(num_subjects, num_clusters);

% Loop through each cluster and calculate the average values
for c = 1:num_clusters
    cluster_indices = (L == c);
    
    for subj = 1:num_subjects
        avg_HIT(subj, c) = mean(RSA_HIT(subj, cluster_indices));
        avg_MISS(subj, c) = mean(RSA_MISS(subj, cluster_indices));
        avg_Hit_MISS(subj, c) = mean(RSA_HIT_Miss(subj, cluster_indices));
    end
end

% Calculate the overall average across subjects for each cluster
mean_HIT = mean(avg_HIT, 1);
mean_MISS = mean(avg_MISS, 1);

% Plot the average values for each cluster in separate subplots
figure;
for c = 1:num_clusters
    subplot(ceil(num_clusters / 2), 2, c);
    bar([mean_HIT(c), mean_MISS(c)]);
    set(gca, 'XTickLabel', {'HIT', 'MISS'});
    title(['Cluster ' num2str(c)]);
    ylabel('Average Value');
end

% Adjust the figure
set(gcf, 'Position', [100, 100, 800, 600]); % Adjust the figure size if needed
Age=["Young",'Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Young','Old','Old','Old','Old','Old','Old','Old','Old','Old','Old','Old','Old'];
predictors = [Age', avg_HIT(:,1), avg_MISS(:,1)];
Age=Age';
avg_HIT_m=avg_HIT(:,5);
avg_MISS_m=avg_MISS(:,5);
avg_HIT_Miss_m=avg_Hit_MISS(:,5);
avg2_Hit_Miss=avg_HIT_m-avg_MISS_m;
% Create a table for the data (optional, but useful for readability)
data = table(Age,avg_HIT_m, avg_MISS_m,avg2_Hit_Miss,avg_HIT_Miss_m);

% Perform the linear regression using fitlm
model1 = fitlm(data, 'avg_HIT_Miss_m ~ Age ');

% Display the summary of the model
disp(model1);

%%
% Assuming p_values is a 4x26x26 matrix containing the p-values
% Load or generate p_values
% load('p_values.mat');

% Threshold for significance
threshold = 0.05;

% Create a figure to hold the subplots
figure;

for i = 1:4
    % Extract the p-values for the current region
    region_p_values = squeeze(corrected_pvalues(i, :, :));
    
    % Create a binary mask where p-values < 0.05
    significant_mask = region_p_values < threshold;
    region_mask(i,:,:)=significant_mask;
    
    % Plot the significant p-values
    subplot(2, 2, i);
    imagesc(significant_mask);
    colormap(gray); % Use a grayscale colormap
    colorbar;
    title(['Region ' num2str(i) ' Significant P-values (p < 0.05)']);
    xlabel('X-axis');
    ylabel('Y-axis');
    axis equal tight;
end

% Adjust the overall figure properties
sgtitle('Significant P-values (p < 0.05) for Each Region');
%%
% Combine the predictor variables into a matrix
predictors = [Age, CESD, ERQS];

% Create a table for the data (optional, but useful for readability)
data = table(Age, CESD, ERQS, NegPosHippo);

% Perform the linear regression using fitlm
model163 = fitlm(data, 'NegPosHippo ~ Age + CESD + ERQS');

% Display the summary of the model
disp(model163);

%%
% MCC_processed(squeeze(p_values(1,:,:)))
% function y = MCC_processed(x)
% 
% y = zeros(size(x));
% [significant_indices, ~, ~] = mult_comp_correction(x, 1000);
% z = significant_indices(:);
% y(z(z>0)) = 1;
% 
% end
for i=1:4
[corrected_pvalues(i,:,:)] = mult_comp_correction(squeeze(p_values(i,:,:)), 1000);
end
%%
function corrected_p_values = mult_comp_correction(input, perm)
    % This function receives a matrix of p-values and returns the corrected
    % p-values for significant clusters using permutation testing.

    % Size of the input matrix
    [rows, cols] = size(input);
    
    % Vectorize the input matrix
    vec = input(:);

    % Preallocate permutation statistics
    perm_stats1 = zeros(perm, 1);

    % Perform permutations
    for z = 1:perm
        % Permute the vectorized matrix
        ind = randperm(length(vec));
        new_vec = vec(ind);
        
        % Reshape back to the original size
        new_input = reshape(new_vec, [rows, cols]);

        % Perform connected component labeling on permuted matrix
        [L, n] = bwlabel(new_input < 0.05, 4);  % Considering p-value threshold of 0.05
        
        % Find the largest cluster size in the permuted matrix
        max_n = 0;
        for i = 1:n
            r = sum(L(:) == i);
            if r > max_n
                max_n = r;
            end
        end
        perm_stats1(z) = max_n;
    end

    % Sort permutation statistics
    perm_stats1 = sort(perm_stats1, 'descend');
    
    % Determine the cluster size threshold for significance
    min_sig_size = perm_stats1(floor(0.05 * perm));
    if min_sig_size == 1
        min_sig_size = 2;
    end

    % Analyze the original input matrix
    [L, n] = bwlabel(input < 0.05, 4);
    cluster_sizes = zeros(n, 1);
    for i = 1:n
        cluster_sizes(i) = sum(L(:) == i);
    end

    % Preallocate corrected p-values matrix
    corrected_p_values = ones(rows, cols);

    % Find significant clusters
    significant_cluster_numbers = find(cluster_sizes >= min_sig_size);
    
    if ~isempty(significant_cluster_numbers)
        for j = 1:length(significant_cluster_numbers)
            cluster_num = significant_cluster_numbers(j);
            cluster_indices = find(L == cluster_num);
            cluster_size = length(cluster_indices);
            
            % Calculate the corrected p-value for this cluster
            corrected_p_value = sum(perm_stats1 >= cluster_size) / perm;
            
            % Assign the corrected p-value to the corresponding positions in the matrix
            corrected_p_values(cluster_indices) = corrected_p_value;
        end
    end
end




